# Multimodal RAG Features Documentation

## Overview

The Agentic RAG System now includes **full multimodal support**, leveraging Gemini 2.5 Flash's native multimodal capabilities to process not just text, but also images, charts, graphs, and diagrams from PDF documents.

## Key Features

### 1. **Automatic Image Extraction from PDFs**

The system automatically extracts all images from PDF documents, including:
- Charts and graphs
- Diagrams and flowcharts
- Photographs and illustrations
- Tables rendered as images
- Infographics

**Technical Details:**
- Uses PyMuPDF (fitz) for efficient image extraction
- Filters out small images (icons, logos) based on configurable size threshold
- Preserves image metadata (page number, position, dimensions)
- Saves images in original format (JPEG, PNG, etc.)

### 2. **AI-Powered Image Description**

Each extracted image is automatically analyzed by Gemini 2.5 Flash, generating detailed descriptions that include:
- Image type (chart, graph, diagram, photo, etc.)
- Main elements and data shown
- Key insights, trends, or patterns
- Text, labels, and annotations present
- Overall purpose or message

**Benefits:**
- Makes visual content searchable through natural language
- Enables semantic understanding of charts and graphs
- Allows retrieval of images based on their content

### 3. **Semantic Image Search**

Search for images using natural language queries:
```python
# Find charts showing trends
results = rag.search_images("chart showing market trends", top_k=5)

# Find specific visualizations
image = rag.get_image_by_description("Show me the Q3 revenue graph")
```

### 4. **Unified Text + Image Embeddings**

The system creates embeddings for:
- **Text chunks** from PDF documents
- **Image descriptions** generated by Gemini

Both are stored in the same vector index, enabling:
- Combined text and image search
- Cross-modal retrieval
- Comprehensive document understanding

### 5. **True Multimodal RAG**

When answering queries, the system can:
- Retrieve relevant text passages
- Find related images and charts
- Reference visual content in responses
- Provide image locations (file path, page number)

## Usage

### Basic Setup

```python
from rag_pipeline import AgenticRAGSystem

# Initialize with Gemini API key
rag = AgenticRAGSystem(
    gemini_api_key="your_api_key",
    pdf_directory="./knowledge_hub"
)
```

### Processing PDFs with Images

```python
# Extract text and images
extracted_data = rag.pdf_processor.extract_text_from_pdf(pdf_path)

print(f"Text chunks: {len(extracted_data['chunks'])}")
print(f"Images extracted: {len(extracted_data['images'])}")

# Process with embeddings and descriptions
chunk_ids, image_ids = rag.embedding_manager.process_document(
    extracted_data,
    rag.gemini_client  # Enables image description
)
```

### Searching for Images

```python
# Search by description
results = rag.search_images("financial performance chart", top_k=5)

for result in results:
    print(f"Image: {result['filename']}")
    print(f"Page: {result['page_number']}")
    print(f"Similarity: {result['similarity']:.3f}")
    print(f"Path: {result['image_path']}")
    print(f"Description: {result['description']}")
```

### Retrieving Specific Images

```python
# Natural language image retrieval
image = rag.get_image_by_description("Show me the trend graph from the Q3 report")

if image:
    print(f"Found: {image['image_path']}")
    print(f"Description: {image['description']}")
    # Display or process the image
```

### Combined Text and Image Queries

```python
# Query returns both text and relevant images
response = rag.process_query("What are our Q3 market trends?")

# The system can reference images in the answer
print(response.answer)  # May reference "as shown in the chart on page 5"

# Get related images
images = rag.search_images("Q3 market trends chart", top_k=3)
```

## Configuration

### PDF Processor Settings

```python
from pdf_parser import PDFProcessor

processor = PDFProcessor(
    extract_images=True,      # Enable image extraction
    min_image_size=50        # Minimum dimension in pixels
)
```

### Image Extraction Control

```python
# Disable image extraction for specific documents
processor = PDFProcessor(extract_images=False)
extracted_data = processor.extract_text_from_pdf(pdf_path)
# Only text will be extracted, no images
```

## Architecture

### Image Processing Pipeline

1. **PDF Ingestion** → PDFProcessor extracts images using PyMuPDF
2. **Image Filtering** → Removes small/insignificant images
3. **Image Storage** → Saves to `extracted_texts/images/`
4. **Gemini Analysis** → Generates detailed descriptions
5. **Embedding Generation** → Creates vector representations
6. **Index Storage** → Stores in local vector database

### Data Flow

```
PDF Document
    │
    ├─→ Text Extraction → Text Chunks → Embeddings → Vector Index
    │
    └─→ Image Extraction → Images → Gemini Description → Image Embeddings → Vector Index
```

### Storage Structure

```
project/
├── extracted_texts/
│   ├── images/                    # Extracted images
│   │   ├── hash_p0_img0.png
│   │   └── hash_p1_img0.jpg
│   └── document_hash.json         # Text extraction data
├── embeddings_cache/
│   ├── vector_index.pkl           # Text + image embeddings
│   └── vector_index.db            # Metadata (SQLite)
```

## Database Schema

### Image Metadata Table

```sql
CREATE TABLE image_metadata (
    image_id TEXT PRIMARY KEY,
    file_path TEXT NOT NULL,
    source_pdf TEXT NOT NULL,
    page_number INTEGER NOT NULL,
    image_path TEXT NOT NULL,
    width INTEGER,
    height INTEGER,
    format TEXT,
    description TEXT,           -- AI-generated description
    created_at TEXT NOT NULL,
    access_count INTEGER DEFAULT 0,
    last_accessed TEXT
);
```

## Performance Considerations

### Image Description Generation

- **Rate Limiting**: Gemini API calls are rate-limited (60 RPM by default)
- **Batch Processing**: Large PDFs with many images process sequentially
- **Caching**: Image descriptions are cached to avoid regeneration
- **Cost**: Each image requires one Gemini API call

### Optimization Tips

1. **Filter Small Images**: Set `min_image_size` appropriately to skip icons/logos
2. **Selective Processing**: Disable image extraction for text-only documents
3. **Batch PDFs**: Process multiple PDFs in off-peak hours
4. **Cache Management**: Image descriptions are stored permanently in database

## API Reference

### PDFProcessor

```python
class PDFProcessor:
    def __init__(self, 
                 output_dir: Optional[Path] = None,
                 extract_images: bool = True,
                 min_image_size: int = 50):
        """Initialize with image extraction settings."""
        
    def extract_text_from_pdf(self, pdf_path: Path) -> Dict[str, Any]:
        """Extract text, metadata, and images from PDF."""
        # Returns dict with 'text', 'chunks', 'images', 'metadata'
    
    def _extract_images_from_pdf(self, pdf_path: Path, file_hash: str) -> List[Dict]:
        """Extract all images from PDF."""
        
    def get_image_base64(self, image_path: Path) -> Optional[str]:
        """Load and encode image as base64."""
```

### GeminiClient

```python
class GeminiClient:
    def describe_image(self, 
                      image_base64: str,
                      mime_type: str = "image/jpeg",
                      prompt: str = None) -> GeminiResponse:
        """Generate description of an image."""
```

### EmbeddingManager

```python
class EmbeddingManager:
    def process_document(self, 
                        document_data: Dict[str, Any],
                        gemini_client=None) -> Tuple[List[str], List[str]]:
        """Process document with optional image description."""
        # Returns (chunk_ids, image_ids)
    
    def process_images(self, 
                       document_data: Dict[str, Any],
                       gemini_client=None) -> List[str]:
        """Process images and generate descriptions."""
    
    def search_images(self, query: str, top_k: int = 5) -> List[Dict]:
        """Search for images by description similarity."""
```

### AgenticRAGSystem

```python
class AgenticRAGSystem:
    def search_images(self, query: str, top_k: int = 5) -> List[Dict]:
        """Search for images using natural language."""
    
    def get_image_by_description(self, description: str) -> Optional[Dict]:
        """Find specific image by description."""
```

## Examples

### Example 1: Financial Report Analysis

```python
# Process financial PDF with charts
extracted = rag.pdf_processor.extract_text_from_pdf("Q3_Report.pdf")
chunk_ids, image_ids = rag.embedding_manager.process_document(
    extracted, rag.gemini_client
)

# Find revenue chart
revenue_chart = rag.get_image_by_description("revenue growth chart Q3")

if revenue_chart:
    print(f"Found on page {revenue_chart['page_number']}")
    print(f"Description: {revenue_chart['description']}")
```

### Example 2: Technical Documentation

```python
# Search for architecture diagrams
diagrams = rag.search_images("system architecture diagram", top_k=3)

for diagram in diagrams:
    print(f"Diagram: {diagram['filename']}, Page {diagram['page_number']}")
    print(f"Similarity: {diagram['similarity']:.2f}")
```

### Example 3: Research Paper Analysis

```python
# Find data visualizations
charts = rag.search_images("chart showing experimental results", top_k=5)

# Query with context
response = rag.process_query("What were the main experimental findings?")
print(response.answer)

# Get supporting visuals
visuals = rag.search_images("experimental results visualization")
```

## Demo Script

Run the included demonstration:

```bash
export GEMINI_API_KEY="your_api_key"
python multimodal_demo.py
```

This demonstrates:
- PDF processing with image extraction
- Automatic image description generation
- Semantic image search
- Specific image retrieval
- Combined text and image queries

## Troubleshooting

### No Images Extracted

**Problem**: Images list is empty after processing
**Solutions**:
- Check if PDF contains actual images (not just text)
- Verify `extract_images=True` in PDFProcessor
- Lower `min_image_size` threshold
- Check PDF is not encrypted or protected

### Image Description Fails

**Problem**: Gemini API errors during description generation
**Solutions**:
- Verify GEMINI_API_KEY is valid
- Check API rate limits (60 RPM default)
- Ensure image format is supported (JPEG, PNG)
- Check image size is not too large

### Poor Search Results

**Problem**: Image search returns irrelevant results
**Solutions**:
- Ensure images have been processed with Gemini descriptions
- Use more specific search queries
- Check embedding model is properly initialized
- Verify vector index contains image embeddings

## Limitations

1. **Image Types**: Best results with charts, graphs, and diagrams. Less effective with abstract images.
2. **Text in Images**: Gemini describes text visible in images, but OCR is not the primary focus.
3. **API Dependency**: Image description requires Gemini API access and counts toward quota.
4. **Processing Time**: Large PDFs with many images take longer to process.
5. **Storage**: Images are stored on disk; large volumes require adequate storage space.

## Future Enhancements

Potential improvements:
- CLIP/SigLIP for direct image embeddings (no text description needed)
- Multi-modal fusion models
- Image similarity search (find visually similar charts)
- Interactive image display in responses
- Image-to-image search
- Video frame extraction and analysis

## Requirements

```
# Already in requirements.txt
Pillow>=10.0.0          # Image processing
PyMuPDF>=1.23.0         # PDF and image extraction
sentence-transformers   # Text embeddings
httpx                   # Gemini API client
```

## Conclusion

The multimodal RAG system now provides true "Visionary" capabilities:
- ✅ Extracts images from PDFs
- ✅ Uses Gemini 2.5 Flash for image understanding
- ✅ Enables natural language image search
- ✅ Retrieves images on demand ("Show me the trend graph")
- ✅ Combines text and visual content for comprehensive answers

This transforms the RAG system from text-only to truly multimodal, unlocking the full power of Gemini 2.5 Flash's vision capabilities.
